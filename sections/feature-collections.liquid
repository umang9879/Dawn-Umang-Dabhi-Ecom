{% comment %}
  Section: cst-collection-slider
  - Title block (only first used)
  - Card blocks (collection selection, custom image option, layout)
  - Navigation block (only first used)
  - Namespaced with #section-{{ section.id }} and class prefix cst-
{% endcomment %}

<section id="section-{{ section.id }}" class="cst-section" aria-label="{{ section.settings.accessibility_label }}">
  <style>
    /* Scoped styles for this section instance */
    #section-{{ section.id }}.cst-section {
      background-color: {{ section.settings.bg_color }};
      padding-top: {{ section.settings.padding_top_desktop | append: 'px' }};
      padding-bottom: {{ section.settings.padding_bottom_desktop | append: 'px' }};
      padding-left: {{ section.settings.padding_left_desktop | append: 'px' }};
      padding-right: {{ section.settings.padding_right_desktop | append: 'px' }};
      box-sizing: border-box;
    }

    /* Mobile paddings via media queries */
    @media (max-width: 767px) {
      #section-{{ section.id }}.cst-section {
        padding-top: {{ section.settings.padding_top_mobile | append: 'px' }};
        padding-bottom: {{ section.settings.padding_bottom_mobile | append: 'px' }};
        padding-left: {{ section.settings.padding_left_mobile | append: 'px' }};
        padding-right: {{ section.settings.padding_right_mobile | append: 'px' }};
      }
    }

    /* Title */
    #section-{{ section.id }} .cst-title {
      margin-bottom: {{ section.settings.gap_desktop | append: 'px' }};
      text-align: {{ section.settings.title_align_desktop }};
      text-transform: {{ section.settings.title_transform }};
      color: {{ section.settings.title_color }};
      font-size: {{ section.settings.title_size_desktop | append: 'px' }};
      line-height: 1.1;
      letter-spacing: 0.6px;
      font-weight: 600;
    }
    @media (max-width: 767px) {
      #section-{{ section.id }} .cst-title {
        text-align: {{ section.settings.title_align_mobile }};
        font-size: {{ section.settings.title_size_mobile | append: 'px' }};
        margin-bottom: {{ section.settings.gap_mobile | append: 'px' }};
      }
    }

    /* Slider wrapper */
    #section-{{ section.id }} .cst-slider-wrap {
      position: relative;
      overflow: hidden;
    }

    #section-{{ section.id }} .cst-slider-track {
      display: flex;
      gap: {{ section.settings.slides_gap | append: 'px' }};
      transition: transform 420ms cubic-bezier(.22,.9,.26,1);
      will-change: transform;
      align-items: stretch;
    }

    /* Card layout 1 - tall card */
    #section-{{ section.id }} .cst-card--layout1 {
      flex: 0 0 auto;
      width: 335px; /* base width */
      height: 450px;
      position: relative;
      overflow: hidden;
      border-radius: 6px;
      display: flex;
      align-items: flex-end;
      box-sizing: border-box;
      background-size: cover;
      background-position: center;
    }

    /* Card inner overlay (blur pseudo-background) */
    #section-{{ section.id }} .cst-card--layout1 .cst-card-inner {
      width: 100%;
      padding: {{ section.settings.card_padding_desktop | append: 'px' }};
      box-sizing: border-box;
      backdrop-filter: blur(0px);
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }
    #section-{{ section.id }} .cst-card--layout1 .cst-cta {
      border: 1px solid rgba(255,255,255,0.9);
      background: transparent;
      padding: 10px 18px;
      text-transform: uppercase;
      font-weight: 600;
      color: white;
      text-decoration: none;
      border-radius: 2px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    /* Card layout 2 - small tile with label below */
    #section-{{ section.id }} .cst-card--layout2 {
      flex: 0 0 auto;
      width: 96px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #section-{{ section.id }} .cst-card--layout2 .cst-thumb {
      width: 96px;
      height: 96px;
      border-radius: 6px;
      background-size: cover;
      background-position: center;
      margin-bottom: 8px;
      box-sizing: border-box;
    }
    #section-{{ section.id }} .cst-card--layout2 .cst-title-small {
      font-size: 13px;
      text-align: center;
      color: #222;
      max-width: 110px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Navigation block styles */
    #section-{{ section.id }} .cst-nav {
      display: flex;
      align-items: center;
      gap: {{ section.settings.nav_gap_desktop | append: 'px' }};
      margin-top: {{ section.settings.gap_desktop | append: 'px' }};
      justify-content: {{ section.settings.nav_alignment }};
    }
    @media (max-width: 767px) {
      #section-{{ section.id }} .cst-nav {
        gap: {{ section.settings.nav_gap_mobile | append: 'px' }};
        margin-top: {{ section.settings.gap_mobile | append: 'px' }};
        justify-content: {{ section.settings.nav_alignment }};
      }
    }

    #section-{{ section.id }} .cst-nav .cst-arrow {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 4px;
      background: transparent;
      border: 1px solid transparent;
      cursor: pointer;
    }

    #section-{{ section.id }} .cst-nav .cst-arrow[disabled] {
      opacity: {{ section.settings.nav_disabled_opacity }};
      cursor: not-allowed;
    }

    /* Link button styles */
    #section-{{ section.id }} .cst-nav .cst-link-btn {
      padding: 12px 20px;
      font-weight: 600;
      border-radius: 2px;
      text-decoration: none;
      display: inline-block;
      text-transform: uppercase;
      font-size: 13px;
    }
    /* outlined style */
    #section-{{ section.id }} .cst-nav .cst-link-btn.outlined {
      background: transparent;
      color: #111;
      border: 1px solid rgba(0,0,0,0.08);
    }
    /* filled style */
    #section-{{ section.id }} .cst-nav .cst-link-btn.filled {
      background: #111;
      color: #fff;
      border: 1px solid transparent;
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
      #section-{{ section.id }} .cst-card--layout1 { width: 280px; height: 380px; }
    }
    @media (max-width: 767px) {
      #section-{{ section.id }} .cst-card--layout1 {
        width: 220px;
        height: 300px;
      }
      #section-{{ section.id }} .cst-slider-track { gap: {{ section.settings.slides_gap | append: 'px' }}; }
    }

    /* Accessibility focus */
    #section-{{ section.id }} .cst-nav button:focus,
    #section-{{ section.id }} .cst-nav .cst-link-btn:focus,
    #section-{{ section.id }} a.cst-cta:focus {
      outline: 3px solid rgba(48,48,159,0.18);
      outline-offset: 2px;
    }
  </style>

  <div class="cst-inner">
    {%- comment -%}
      TITLE BLOCK: render first title block found
    {%- endcomment -%}
    {% assign title_block = nil %}
    {% for block in section.blocks %}
      {% if block.type == 'title' and title_block == nil %}
        {% assign title_block = block %}
      {% endif %}
    {% endfor %}

    {% if title_block %}
      <div class="cst-title" style="
        text-align: {{ title_block.settings.text_align_desktop }};
        color: {{ title_block.settings.text_color }};
        text-transform: {{ title_block.settings.text_transform }};
      ">
        {{ title_block.settings.title_text }}
      </div>
    {% elsif section.settings.show_heading_if_no_block %}
      <div class="cst-title" style="text-align: {{ section.settings.title_align_desktop }};">
        {{ section.settings.fallback_heading }}
      </div>
    {% endif %}

    {%- comment -%}
      SLIDER / CARDS
    {%- endcomment -%}
    <div class="cst-slider-wrap" role="region" aria-roledescription="carousel" aria-label="Collections carousel">
      <div class="cst-slider-track" id="cst-track-{{ section.id }}" data-total="{{ section.blocks | size }}">
        {% for block in section.blocks %}
          {% if block.type == 'card' %}
            {% comment %}
              Determine image source:
                - If custom_image_checkbox true -> use custom_image
                - else if collection selected -> use collection.image
                - else fallback to placeholder
            {% endcomment %}
            {% assign use_custom = block.settings.use_custom_image %}
            {% assign card_img = '' %}
            {% if use_custom and block.settings.custom_image != blank %}
              {% assign card_img = block.settings.custom_image | img_url: 'master' %}
            {% elsif block.settings.collection != blank %}
              {% assign coll = collections[block.settings.collection] %}
              {% if coll != nil and coll.image != nil %}
                {% assign card_img = coll.image | img_url: 'master' %}
              {% endif %}
            {% endif %}

            {% if block.settings.layout == 'layout1' %}
              <div class="cst-card cst-card--layout1" data-layout="layout1" style="background-image: url('{{ card_img | default: '' }}');">
                <div class="cst-card-inner" style="padding: {{ block.settings.card_padding | append: 'px' }};">
                  {% if block.settings.collection != blank %}
                    {% assign c = collections[block.settings.collection] %}
                    <a class="cst-cta" href="{{ c.url }}">{{ c.title }}</a>
                  {% else %}
                    <a class="cst-cta" href="#">{{ block.settings.custom_cta_label | default: 'Shop' }}</a>
                  {% endif %}
                </div>
              </div>
            {% else %}
              <div class="cst-card cst-card--layout2" data-layout="layout2">
                <a href="{% if block.settings.collection != blank %}{{ collections[block.settings.collection].url }}{% else %}#{% endif %}">
                  <div class="cst-thumb" style="background-image: url('{{ card_img | default: '' }}');"></div>
                </a>
                <div class="cst-title-small">
                  {% if block.settings.collection != blank %}
                    {{ collections[block.settings.collection].title }}
                  {% else %}
                    {{ block.settings.custom_title | default: 'Collection' }}
                  {% endif %}
                </div>
              </div>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    </div>

    {%- comment -%}
      NAVIGATION BLOCK
    {%- endcomment -%}
    {% assign nav_block = nil %}
    {% for block in section.blocks %}
      {% if block.type == 'navigation' and nav_block == nil %}
        {% assign nav_block = block %}
      {% endif %}
    {% endfor %}

    {% if nav_block %}
      <div class="cst-nav" id="cst-nav-{{ section.id }}">
        {% comment %} Prev arrow (can be hidden on mobile) {% endcomment %}
        <button
          class="cst-arrow cst-prev"
          id="cst-prev-{{ section.id }}"
          aria-label="Previous"
          {% if nav_block.settings.hide_nav_on_mobile %}data-hide-mobile="true"{% endif %}>
          <!-- simple chevron -->
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M15 18L9 12L15 6" stroke="{{ nav_block.settings.active_arrow_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        {% comment %} Link button {% endcomment %}
        <a href="{{ nav_block.settings.link_url }}" class="cst-link-btn {% if nav_block.settings.link_style == 'outlined' %}outlined{% else %}filled{% endif %}" id="cst-link-{{ section.id }}">
          {{ nav_block.settings.link_label }}
        </a>

        <button
          class="cst-arrow cst-next"
          id="cst-next-{{ section.id }}"
          aria-label="Next"
          {% if nav_block.settings.hide_nav_on_mobile %}data-hide-mobile="true"{% endif %}>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M9 18L15 12L9 6" stroke="{{ nav_block.settings.active_arrow_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    {% endif %}
  </div>

  <script>
    (function() {
      var sectionId = '{{ section.id }}';
      var track = document.getElementById('cst-track-{{ section.id }}');
      if (!track) return;

      var prevBtn = document.getElementById('cst-prev-{{ section.id }}');
      var nextBtn = document.getElementById('cst-next-{{ section.id }}');
      var totalCards = track.children.length;
      var index = 0;

      // Calculate visible count based on container width and first child width
      function calcVisible() {
        var wrap = track.parentElement;
        var wrapW = wrap.clientWidth;
        if (track.children.length === 0) return 1;
        var child = track.querySelector('.cst-card');
        if (!child) return 1;
        var style = window.getComputedStyle(child);
        var childW = child.getBoundingClientRect().width + parseFloat(getComputedStyle(track).gap || 0);
        var visible = Math.max(1, Math.floor((wrapW + 1) / childW));
        return visible;
      }

      function updateButtons() {
        var visible = calcVisible();
        if (prevBtn) prevBtn.disabled = index <= 0;
        if (nextBtn) nextBtn.disabled = (index + visible) >= totalCards;
        // set opacity for disabled
        var disabledOpacity = {{ nav_block.settings.nav_disabled_opacity | default: 0.5 }};
        if (prevBtn) prevBtn.style.opacity = prevBtn.disabled ? disabledOpacity : 1;
        if (nextBtn) nextBtn.style.opacity = nextBtn.disabled ? disabledOpacity : 1;
      }

      function scrollToIndex(i) {
        index = Math.max(0, Math.min(i, Math.max(0, totalCards - 1)));
        var child = track.querySelector('.cst-card');
        if (!child) return;
        var gap = parseFloat(getComputedStyle(track).gap || {{ section.settings.slides_gap | default: 8 }});
        var childRect = child.getBoundingClientRect();
        var wrapRect = track.parentElement.getBoundingClientRect();
        // Find left position of target child relative to track
        var target = track.children[index];
        var offset = target.offsetLeft;
        track.style.transform = 'translateX(' + (-offset) + 'px)';
        updateButtons();
      }

      if (prevBtn) {
        prevBtn.addEventListener('click', function(){
          var visible = calcVisible();
          scrollToIndex(index - visible);
        });
      }
      if (nextBtn) {
        nextBtn.addEventListener('click', function(){
          var visible = calcVisible();
          scrollToIndex(index + visible);
        });
      }

      // Keyboard navigation
      track.parentElement.addEventListener('keydown', function(e){
        if (e.key === 'ArrowLeft' && prevBtn) prevBtn.click();
        if (e.key === 'ArrowRight' && nextBtn) nextBtn.click();
      });

      // Resize handling
      var resizeTimer;
      function onResize() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function(){
          // ensure index is valid after resize
          var visible = calcVisible();
          if (index + visible > totalCards) index = Math.max(0, totalCards - visible);
          scrollToIndex(index);
          // hide mobile arrows if requested
          var hideOnMobile = {{ nav_block.settings.hide_nav_on_mobile | default: false }};
          if (hideOnMobile) {
            var isMobile = window.matchMedia('(max-width: 767px)').matches;
            if (prevBtn) prevBtn.style.display = isMobile ? 'none' : '';
            if (nextBtn) nextBtn.style.display = isMobile ? 'none' : '';
          }
        }, 80);
      }
      window.addEventListener('resize', onResize);
      // initial layout
      onResize();
      // initial index 0
      scrollToIndex(0);
    })();
  </script>

  {% schema %}
  {
    "name": "CST Collections Slider",
    "tag": "section",
    "settings": [
      {
        "type": "text",
        "id": "accessibility_label",
        "label": "Accessibility label (aria-label)",
        "default": "Collections carousel"
      },
      {
        "type": "color",
        "id": "bg_color",
        "label": "Background color",
        "default": "#F5F5F5"
      },
      {
        "type": "range",
        "id": "padding_top_desktop",
        "label": "Padding top (desktop px)",
        "min": 0,
        "max": 100,
        "step": 1,
        "default": 96
      },
      {
        "type": "range",
        "id": "padding_bottom_desktop",
        "label": "Padding bottom (desktop px)",
        "min": 0,
        "max": 100,
        "step": 1,
        "default": 96
      },
      {
        "type": "range",
        "id": "padding_left_desktop",
        "label": "Padding left (desktop px)",
        "min": 0,
        "max": 100,
        "step": 1,
        "default": 64
      },
      {
        "type": "range",
        "id": "padding_right_desktop",
        "label": "Padding right (desktop px)",
        "min": 0,
        "max": 100,
        "step": 1,
        "default": 64
      },

      {
        "type": "range",
        "id": "padding_top_mobile",
        "label": "Padding top (mobile px)",
        "min": 0,
        "max": 100,
        "step": 1,
        "default": 56
      },
      {
        "type": "range",
        "id": "padding_bottom_mobile",
        "label": "Padding bottom (mobile px)",
        "min": 0,
        "max": 100,
        "step": 1,
        "default": 56
      },
      {
        "type": "range",
        "id": "padding_left_mobile",
        "label": "Padding left (mobile px)",
        "min": 0,
        "max": 80,
        "step": 1,
        "default": 16
      },
      {
        "type": "range",
        "id": "padding_right_mobile",
        "label": "Padding right (mobile px)",
        "min": 0,
        "max": 80,
        "step": 1,
        "default": 16
      },

      {
        "type": "range",
        "id": "gap_desktop",
        "label": "Gap between title / slider / nav (desktop px)",
        "min": 0,
        "max": 100,
        "step": 1,
        "default": 56
      },
      {
        "type": "range",
        "id": "gap_mobile",
        "label": "Gap between title / slider / nav (mobile px)",
        "min": 0,
        "max": 100,
        "step": 1,
        "default": 40
      },
      {
        "type": "range",
        "id": "slides_gap",
        "label": "Gap between slides (px)",
        "min": 0,
        "max": 60,
        "step": 1,
        "default": 8
      },

      {
        "type": "checkbox",
        "id": "show_heading_if_no_block",
        "label": "Show fallback heading if title block missing",
        "default": false
      },
      {
        "type": "text",
        "id": "fallback_heading",
        "label": "Fallback heading text",
        "default": "Doors For Every Home"
      }
    ],
    "blocks": [
      {
        "type": "title",
        "name": "Title",
        "settings": [
          {
            "type": "text",
            "id": "title_text",
            "label": "Title text",
            "default": "SHOP BY FINISH"
          },
          {
            "type": "select",
            "id": "text_align_desktop",
            "label": "Text align (desktop)",
            "options": [
              { "value": "left", "label": "Left" },
              { "value": "center", "label": "Center" },
              { "value": "right", "label": "Right" }
            ],
            "default": "center"
          },
          {
            "type": "select",
            "id": "text_align_mobile",
            "label": "Text align (mobile)",
            "options": [
              { "value": "left", "label": "Left" },
              { "value": "center", "label": "Center" },
              { "value": "right", "label": "Right" }
            ],
            "default": "center"
          },
          {
            "type": "select",
            "id": "text_transform",
            "label": "Text transform",
            "options": [
              { "value": "none", "label": "None" },
              { "value": "uppercase", "label": "Uppercase" }
            ],
            "default": "uppercase"
          },
          {
            "type": "color",
            "id": "text_color",
            "label": "Text color",
            "default": "#30309F"
          },
          {
            "type": "range",
            "id": "title_size_desktop",
            "label": "Font size (desktop px)",
            "min": 12,
            "max": 64,
            "step": 1,
            "default": 32
          },
          {
            "type": "range",
            "id": "title_size_mobile",
            "label": "Font size (mobile px)",
            "min": 10,
            "max": 40,
            "step": 1,
            "default": 24
          }
        ]
      },
      {
        "type": "card",
        "name": "Card",
        "settings": [
          {
            "type": "collection",
            "id": "collection",
            "label": "Select collection (optional)"
          },
          {
            "type": "checkbox",
            "id": "use_custom_image",
            "label": "Use custom image instead of collection image",
            "default": false
          },
          {
            "type": "image_picker",
            "id": "custom_image",
            "label": "Custom image (only used if above checked)"
          },
          {
            "type": "select",
            "id": "layout",
            "label": "Card layout",
            "options": [
              { "value": "layout1", "label": "Layout 1 — Large card (335 x 450)" },
              { "value": "layout2", "label": "Layout 2 — Small tile (96 x 96)" }
            ],
            "default": "layout1"
          },
          {
            "type": "range",
            "id": "card_padding",
            "label": "Card inner padding (px)",
            "min": 0,
            "max": 60,
            "step": 1,
            "default": 24
          },
          {
            "type": "text",
            "id": "custom_cta_label",
            "label": "CTA label for layout1 when no collection",
            "default": "Find out"
          },
          {
            "type": "text",
            "id": "custom_title",
            "label": "Custom title for layout2 when no collection",
            "default": "Collection"
          }
        ]
      },
      {
        "type": "navigation",
        "name": "Navigation",
        "settings": [
          {
            "type": "select",
            "id": "nav_alignment",
            "label": "Navigation alignment",
            "options": [
              { "value": "flex-start", "label": "Left" },
              { "value": "center", "label": "Center" },
              { "value": "flex-end", "label": "Right" }
            ],
            "default": "center"
          },
          {
            "type": "range",
            "id": "nav_gap_desktop",
            "label": "Navigation gap (desktop px)",
            "min": 0,
            "max": 100,
            "step": 1,
            "default": 40
          },
          {
            "type": "range",
            "id": "nav_gap_mobile",
            "label": "Navigation gap (mobile px)",
            "min": 0,
            "max": 60,
            "step": 1,
            "default": 8
          },
          {
            "type": "select",
            "id": "link_style",
            "label": "Link button style",
            "options": [
              { "value": "outlined", "label": "Outlined" },
              { "value": "filled", "label": "Filled" }
            ],
            "default": "outlined"
          },
          {
            "type": "text",
            "id": "link_label",
            "label": "Link button label",
            "default": "FIND"
          },
          {
            "type": "url",
            "id": "link_url",
            "label": "Link button URL"
          },
          {
            "type": "checkbox",
            "id": "hide_nav_on_mobile",
            "label": "Hide prev/next arrows on mobile (show link button only)",
            "default": true
          },
          {
            "type": "color",
            "id": "active_arrow_color",
            "label": "Active arrow color",
            "default": "#30309F"
          },
          {
            "type": "range",
            "id": "nav_disabled_opacity",
            "label": "Disabled arrow opacity (0-1)",
            "min": 0,
            "max": 1,
            "step": 0.1,
            "default": 0.5
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "CST Collections Slider",
        "category": "Collections",
        "blocks": [
          { "type": "title" },
          { "type": "card" },
          { "type": "card" },
          { "type": "card" },
          { "type": "navigation" }
        ]
      }
    ],
    "max_blocks": 30
  }
  {% endschema %}
</section>
